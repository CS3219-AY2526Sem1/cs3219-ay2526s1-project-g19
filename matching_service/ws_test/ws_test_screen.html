<!DOCTYPE html>
<html>
    <head>
        <title>WebSocket Chat</title>
    </head>
    <body>
        <h1>WebSocket Chat</h1>

        <!-- Input for User ID -->
        <input type="text" id="userIdInput" placeholder="Enter user ID" autocomplete="off"/>
        <button id="connectBtn">Connect</button>
        <button id="disconnectBtn">Disconnect</button>

        <form id="messageForm" action="" onsubmit="sendMessage(event)">
            <input type="text" id="messageText" autocomplete="off"/>
            <button>Send</button>
        </form>

        <ul id='messages'></ul>

        <script>
            let ws; // WebSocket variable

            function printMessage(msg) {
                const messages = document.getElementById('messages');
                const message = document.createElement('li');
                message.textContent = msg;
                messages.appendChild(message);
            }

            document.getElementById("connectBtn").onclick = function() {
                const userId = document.getElementById("userIdInput").value.trim();
                const topic = document.getElementById("messageText").value.trim(); // take from textbox

                if (!userId) {
                    alert("Please enter a user ID.");
                    return;
                }
                if (!topic) {
                    alert("Please enter a topic in the message input.");
                    return;
                }

                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    // Open websocket
                    ws = new WebSocket(`ws://localhost:8001/api/ws?user_id=${userId}`);

                    // ðŸ”¹ Immediately send POST to /api/match
                    fetch("http://127.0.0.1:8001/api/match", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            user_id: userId,
                            topics: [topic]
                        })
                    })
                    .then(res => res.json())
                    .then(data => {
                        printMessage(`Match API response: ${data}`);
                    })
                    .catch(err => printMessage(`Error calling /api/match: ${err}`));
                    printMessage(`Topic sent: ${topic}`)

                    ws.onopen = function() {
                        ws.send("Client requesting match");
                        printMessage(`Connected as user ${userId}`)
                    };

                    ws.onmessage = function(event) {
                        const messages = document.getElementById('messages');
                        printMessage(event.data)
                    };

                    ws.onclose = function() {
                        printMessage("WebSocket connection closed.")
                    };

                    ws.onerror = function(err) {
                        printMessage("WebSocket error:", err);
                    };
                }
            };

            document.getElementById("disconnectBtn").onclick = function() {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.close();
                    ws = null;
                }
            };

            function sendMessage(event) {
                const input = document.getElementById("messageText");
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(input.value);
                } else {
                    alert("WebSocket is not connected.");
                }
                input.value = '';
                event.preventDefault();
            }
        </script>
    </body>
</html>
